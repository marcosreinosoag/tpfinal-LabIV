<nav class="navbar-clinica">
  <div class="logo">
    <img src="assets/images/icono.ico" alt="Cl√≠nica" />
    <div class="titulo-logo">
      <h2>Cl√≠nica OnLine</h2>
      <span>Especialistas en Salud</span>
    </div>
  </div>
  <ul class="navbar-links">
    <li><button (click)="goTo('solicitar-turno')">Solicitar Turno</button></li>
    <li><button (click)="toggleVista(false)">Mis Turnos</button></li>
    <li><button (click)="toggleVista(true)">Mi Perfil</button></li>
    <li><button class="logout-btn" (click)="logout()">Cerrar sesi√≥n</button></li>
  </ul>
</nav>

<!-- PERFIL -->
<div class="perfil-container" *ngIf="mostrarPerfil && userData">
  <h2>Mi Perfil</h2>
  <img [src]="userData.fotoPerfil" alt="Foto de perfil" class="foto-perfil" />
  <div class="datos-usuario">
    <p><strong>Nombre:</strong> {{ userData.nombre }}</p>
    <p><strong>Apellido:</strong> {{ userData.apellido }}</p>
    <p><strong>Edad:</strong> {{ userData.edad }}</p>
    <p><strong>DNI:</strong> {{ userData.dni }}</p>
    <p><strong>Obra Social:</strong> {{ userData.obraSocial }}</p>
    <p><strong>Mail:</strong> {{ userData.mail }}</p>
  </div>
</div>

<div *ngIf="mostrarPerfil && historiasClinicas.length > 0" class="historias-clinicas">

  <div class="historial-header">
    <h3>Historial Cl√≠nico</h3>

    <div class="descarga-contenedor">
      <button class="btn-descarga-total" (click)="descargarHistoriaClinica()">
        üìÑ Descargar Todo el Historial Cl√≠nico
      </button>

      <div class="descarga-individual">
        <label for="select-especialidad">
          <strong>üìã Por especialidad:</strong>
        </label>
        <select id="select-especialidad" [(ngModel)]="filtroEspecialidad">
          <option value="" disabled selected>Seleccionar especialidad</option>
          <option *ngFor="let especialidad of especialidades" [value]="especialidad">
            {{ especialidad }}
          </option>
        </select>
        <button class="btn-descarga-por" [disabled]="!filtroEspecialidad"
          (click)="descargarHistoriaPorEspecialidad(filtroEspecialidad!)">
          üì• Descargar
        </button>
      </div>
    </div>
  </div>


  <div *ngFor="let h of historiasClinicas" class="card">
    <div class="card-header">
      <p><strong>Fecha:</strong> {{ h.fecha | date:'dd/MM/yyyy' }}</p>
      <p><strong>Especialista:</strong> {{ getNombreEspecialista(h.especialista_id) }}</p>
      <p><strong>Especialidad:</strong> {{ datosTurno(h.turno_id)?.especialidad }}</p>
    </div>
    <div class="card-body">
      <p><strong>Altura:</strong> {{ h.altura }} cm</p>
      <p><strong>Peso:</strong> {{ h.peso }} kg</p>
      <p><strong>Presi√≥n:</strong> {{ h.presion }}</p>
      <p><strong>Temperatura:</strong> {{ h.temperatura }} ¬∞C</p>
      
      <!-- Mostrar los 3 campos din√°micos con nombres descriptivos -->
      <div *ngIf="h.datos_extra">
        <p *ngIf="h.datos_extra.rangoDinamico !== undefined">
          <strong>Bienestar del paciente:</strong> {{ h.datos_extra.rangoDinamico }}
        </p>
        <p *ngIf="h.datos_extra.valorNumerico !== undefined">
          <strong>Cantidad de consultas:</strong> {{ h.datos_extra.valorNumerico }}
        </p>
        <p *ngIf="h.datos_extra.switchSiNo !== undefined">
          <strong>Alergias:</strong> {{ h.datos_extra.switchSiNo }}
        </p>
      </div>

      <!-- Mostrar otros datos extra adicionales (excluyendo los 3 campos din√°micos) -->
      <div *ngIf="getDatosExtraAdicionales(h.datos_extra).length > 0">
        <p><strong>Otros Datos</strong></p>
        <ul>
          <li *ngFor="let item of getDatosExtraAdicionales(h.datos_extra)">
            {{ item.clave }}: {{ item.valor }}
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>



<!-- TURNOS -->
<div class="hero-background" *ngIf="!mostrarPerfil">
  <div class="turnos-wrapper">
    <!-- Filtros -->
    <div class="filtro-busqueda-libre">
      <label for="busquedaLibre">üîé Buscar por cualquier dato (turno o historia cl√≠nica):</label>
      <input id="busquedaLibre" type="text" [(ngModel)]="busquedaLibre"
        placeholder="Ej: Dermatologia, Comedones, ..." />
    </div>

    <div *ngFor="let turno of turnosFiltrados()" [ngClass]="'turno-card ' + turno.estado">
      <p><strong>Especialista:</strong> {{ getNombreEspecialista(turno.especialista) }}</p>
      <p><strong>Especialidad:</strong> {{ turno.especialidad }}</p>
      <p><strong>Fecha:</strong> {{ turno.fecha | date:'dd/MM/yyyy' }} {{ turno.hora }}</p>
      <div class="estado" [ngClass]="turno.estado">Estado: {{ turno.estado | uppercase }}</div>

      <!-- Mostrar bot√≥n solo si el turno fue realizado -->
      <ng-container *ngIf="turno.estado === 'realizado' && historiaDelTurno(turno.id)">
        <button class="btn-diagnostico" (click)="toggleHistoria(turno.id)">
          {{ historiaVisible[turno.id] ? 'Ocultar' : 'Ver' }} Historia Cl√≠nica
        </button>

        <div *ngIf="historiaVisible[turno.id]" class="historia-clinica-box">
          <h4>ü©∫ Historia Cl√≠nica</h4>
          <ng-container *ngIf="historiaDelTurno(turno.id) as historia">
            <p><strong>Altura:</strong> {{ historia.altura }} cm</p>
            <p><strong>Peso:</strong> {{ historia.peso }} kg</p>
            <p><strong>Presi√≥n:</strong> {{ historia.presion }}</p>
            <p><strong>Temperatura:</strong> {{ historia.temperatura }} ¬∞C</p>
            
            <!-- Mostrar los 3 campos din√°micos con nombres descriptivos -->
            <div *ngIf="historia.datos_extra">
              <p *ngIf="historia.datos_extra.rangoDinamico !== undefined">
                <strong>Bienestar del paciente:</strong> {{ historia.datos_extra.rangoDinamico }}
              </p>
              <p *ngIf="historia.datos_extra.valorNumerico !== undefined">
                <strong>Cantidad de consultas:</strong> {{ historia.datos_extra.valorNumerico }}
              </p>
              <p *ngIf="historia.datos_extra.switchSiNo !== undefined">
                <strong>Alergias:</strong> {{ historia.datos_extra.switchSiNo }}
              </p>
            </div>

            <!-- Mostrar otros datos extra adicionales (excluyendo los 3 campos din√°micos) -->
            <ul *ngIf="getDatosExtraAdicionales(historia.datos_extra).length > 0">
              <li *ngFor="let item of getDatosExtraAdicionales(historia.datos_extra)">
                {{ item.clave }}: {{ item.valor }}
              </li>
            </ul>
          </ng-container>
        </div>
      </ng-container>

      <!-- Acciones -->
      <div class="acciones">
        <ng-container *ngIf="puedeCancelar(turno)">
          <button (click)="mostrarCancelar(turno.id)">Cancelar turno</button>
          <div *ngIf="comentarioCancelacion[turno.id] !== undefined">
            <textarea [(ngModel)]="comentarioCancelacion[turno.id]" placeholder="Motivo de cancelaci√≥n"></textarea>
            <button (click)="cancelarTurno(turno.id)">Confirmar</button>
          </div>
        </ng-container>

        <button *ngIf="puedeVerResena(turno)" (click)="verResena(turno)">Ver Rese√±a</button>

        <ng-container *ngIf="puedeCalificar(turno)">
          <button (click)="mostrarComentario(turno.id)">Calificar atenci√≥n</button>
          <div *ngIf="comentarioAtencion[turno.id] !== undefined">
            <textarea [(ngModel)]="comentarioAtencion[turno.id]" placeholder="Comentario sobre la atenci√≥n"></textarea>
            <button (click)="calificarAtencion(turno.id)">Enviar</button>
          </div>
        </ng-container>

        <!-- Bot√≥n para completar encuesta -->
        <ng-container *ngIf="puedeCompletarEncuesta(turno)">
          <button class="btn-encuesta" (click)="abrirEncuesta(turno.id)">
            üìã Completar Encuesta
          </button>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Encuesta -->
<div class="modal-encuesta-overlay" *ngIf="mostrarModalEncuesta" (click)="cerrarEncuesta()"></div>
<div class="modal-encuesta" *ngIf="mostrarModalEncuesta" (click)="$event.stopPropagation()">
  <div class="modal-encuesta-content">
    <div class="modal-encuesta-header">
      <h2>üìã Encuesta de Satisfacci√≥n</h2>
      <button class="btn-cerrar" (click)="cerrarEncuesta()">‚úï</button>
    </div>
    
    <form class="form-encuesta" (ngSubmit)="enviarEncuesta()">
      <!-- 1. Estrellas para calificar -->
      <div class="campo-encuesta">
        <label>¬øC√≥mo calificar√≠a la atenci√≥n recibida? *</label>
        <div class="rating-stars">
          <span 
            *ngFor="let star of [1,2,3,4,5]; let i = index"
            class="star"
            [class.active]="(hoverEstrella > 0 ? hoverEstrella : encuestaData.calificacionEstrellas) >= (i + 1)"
            (click)="encuestaData.calificacionEstrellas = i + 1"
            (mouseenter)="hoverEstrella = i + 1"
            (mouseleave)="hoverEstrella = 0">
            ‚≠ê
          </span>
        </div>
        <span class="rating-value">{{ encuestaData.calificacionEstrellas }}/5</span>
      </div>

      <!-- 2. Radio button -->
      <div class="campo-encuesta">
        <label>¬øRecomendar√≠a nuestro servicio? *</label>
        <div class="radio-group">
          <label>
            <input 
              type="radio" 
              name="recomendacion" 
              value="si"
              [(ngModel)]="encuestaData.recomendacion"
              [ngModelOptions]="{standalone: true}">
            S√≠, definitivamente
          </label>
          <label>
            <input 
              type="radio" 
              name="recomendacion" 
              value="talvez"
              [(ngModel)]="encuestaData.recomendacion"
              [ngModelOptions]="{standalone: true}">
            Tal vez
          </label>
          <label>
            <input 
              type="radio" 
              name="recomendacion" 
              value="no"
              [(ngModel)]="encuestaData.recomendacion"
              [ngModelOptions]="{standalone: true}">
            No
          </label>
        </div>
      </div>

      <!-- 3. Check box (m√∫ltiples opciones) -->
      <div class="campo-encuesta">
        <label>¬øQu√© aspectos destacar√≠a de la atenci√≥n? (Puede seleccionar varios) *</label>
        <div class="checkbox-group">
          <label>
            <input 
              type="checkbox" 
              [(ngModel)]="encuestaData.aspectos.puntualidad"
              [ngModelOptions]="{standalone: true}">
            Puntualidad
          </label>
          <label>
            <input 
              type="checkbox" 
              [(ngModel)]="encuestaData.aspectos.profesionalismo"
              [ngModelOptions]="{standalone: true}">
            Profesionalismo
          </label>
          <label>
            <input 
              type="checkbox" 
              [(ngModel)]="encuestaData.aspectos.amabilidad"
              [ngModelOptions]="{standalone: true}">
            Amabilidad
          </label>
          <label>
            <input 
              type="checkbox" 
              [(ngModel)]="encuestaData.aspectos.instalaciones"
              [ngModelOptions]="{standalone: true}">
            Instalaciones
          </label>
          <label>
            <input 
              type="checkbox" 
              [(ngModel)]="encuestaData.aspectos.tiempoEspera"
              [ngModelOptions]="{standalone: true}">
            Tiempo de espera
          </label>
        </div>
      </div>

      <!-- 4. Control de rango -->
      <div class="campo-encuesta">
        <label>Nivel de satisfacci√≥n general (0-100) *</label>
        <div class="range-container-encuesta">
          <input 
            type="range" 
            min="0" 
            max="100" 
            step="1"
            [(ngModel)]="encuestaData.satisfaccionGeneral"
            [ngModelOptions]="{standalone: true}"
            class="range-input-encuesta">
          <span class="range-value-encuesta">{{ encuestaData.satisfaccionGeneral }}%</span>
        </div>
      </div>

      <!-- 5. SOLO UN cuadro de texto -->
      <div class="campo-encuesta">
        <label>Comentarios adicionales (opcional)</label>
        <textarea 
          [(ngModel)]="encuestaData.comentarios"
          [ngModelOptions]="{standalone: true}"
          placeholder="Escriba aqu√≠ sus comentarios, sugerencias o recomendaciones..."
          rows="4"
          class="textarea-encuesta"></textarea>
      </div>

      <div class="modal-encuesta-footer">
        <button type="button" class="btn-cancelar" (click)="cerrarEncuesta()">Cancelar</button>
        <button type="submit" class="btn-enviar" [disabled]="!esEncuestaValida()">Enviar Encuesta</button>
      </div>
    </form>
  </div>
</div>